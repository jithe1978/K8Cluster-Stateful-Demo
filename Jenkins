pipeline {
  agent any

  environment {
    AWS_REGION     = 'us-east-2'
    AWS_ACCOUNT_ID = '577999460012'
    
    ECR_REGISTRY   = "577999460012.dkr.ecr.us-east-2.amazonaws.com"
    ECR_BACKEND    = "577999460012.dkr.ecr.us-east-2.amazonaws.com/mern-backend"
    ECR_FRONTEND   = "577999460012.dkr.ecr.us-east-2.amazonaws.com/mern-frontend"
    // IMAGE_TAG is now set in the 'Checkout' stage
  }

  options { disableConcurrentBuilds(); timestamps() }

  stages {
    stage('Checkout'){ 
      steps { 
        checkout scm 
        script {
          // Set IMAGE_TAG *after* checkout so env.GIT_COMMIT exists
          env.IMAGE_TAG = env.GIT_COMMIT.take(7)
          echo "IMAGE_TAG=${env.IMAGE_TAG}"
        }
      } 
    }

    stage('Init Tooling'){
      steps {
        // This stage just sets up the kubeconfig
        withCredentials([
          string(credentialsId: 'kubeconfig-content', variable: 'KUBECONFIG_CONTENT')
        ]) {
          powershell '''
            Set-Content -Path "$env:WORKSPACE\\kubeconfig" -Value $env:KUBECONFIG_CONTENT -Encoding Ascii
            
            # Set KUBECONFIG for all subsequent stages
            $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"

            aws --version
            kubectl version --client=true
            helm version
          '''
        }
      }
    }

    stage('ECR Login & Repos'){
      steps {
        // *** FIX ***
        // We MUST load the aws-creds in THIS stage
        withCredentials([
          usernamePassword(credentialsId: 'aws-creds', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          powershell '''
            # Now this command will run authenticated
            aws ecr get-login-password --region $env:AWS_REGION |
              docker login --username AWS --password-stdin $env:ECR_REGISTRY

            # Correct PowerShell "try/create" logic
            aws ecr describe-repositories --repository-names mern-backend --region $env:AWS_REGION 2>$null
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Repository 'mern-backend' not found, creating it..."
              aws ecr create-repository --repository-name mern-backend --region $env:AWS_REGION | Out-Null
            }

            aws ecr describe-repositories --repository-names mern-frontend --region $env:AWS_REGION 2>$null
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Repository 'mern-frontend' not found, creating it..."
              aws ecr create-repository --repository-name mern-frontend --region $env:AWS_REGION | Out-Null
            }
          '''
        }
      }
    }

    stage('Build & Push Images'){
      steps {
        // *** FIX ***
        // Load credentials here as well for docker push
        withCredentials([
          usernamePassword(credentialsId: 'aws-creds', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          powershell '''
            Write-Host "Building backend in $env:WORKSPACE\\API-jokes"
            Set-Location "$env:WORKSPACE\\API-jokes"
            
            docker build -t $env:ECR_BACKEND:$env:IMAGE_TAG -t $env:ECR_BACKEND:latest -f Dockerfile.prod .
            
            # This push now works because of the successful login
            docker push $env:ECR_BACKEND:$env:IMAGE_TAG
            docker push $env:ECR_BACKEND:latest

            Write-Host "Building frontend in $env:WORKSPACE\\react-client"
            Set-Location "$env:WORKSPACE\\react-client"

            docker build -t $env:ECR_FRONTEND:$env:IMAGE_TAG -t $env:ECR_FRONTEND:latest -f Dockerfile.prod .
            docker push $env:ECR_FRONTEND:$env:IMAGE_TAG
            docker push $env:ECR_FRONTEND:latest
          '''
        }
      }
    }

    stage('Namespace & Secret check (mernapp)'){
      steps {
        powershell '''
          $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
          kubectl get ns mernapp 2>$null; if ($LASTEXITCODE -ne 0) { kubectl create ns mernapp }
          
          # This command will fail if the secret doesnt exist. 
          # You may need to create it manually or add it to your Helm chart.
          kubectl -n mernapp get secret mongodb-cred
        '''
      }
    }

    stage('Deploy Backend (Helm)'){
      steps {
        powershell '''
          $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
          
          Set-Location "$env:WORKSPACE\\K8s-helm\\backend"
          
          helm upgrade --install backend . -n mernapp `
            --set container.image=$env:ECR_BACKEND:$env:IMAGE_TAG `
            --set container.port=5000 `
            --wait --timeout 300s
          kubectl -n mernapp rollout status deploy/mern-backend --timeout=300s
        '''
      }
    }

    stage('Deploy Frontend (Helm)'){
      steps {
        powershell '''
          $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
          
          Set-Location "$env:WORKSPACE\\K8s-helm\\frontend"
          
          helm upgrade --install frontend . -n mernapp `
            --set container.image=$env:ECR_FRONTEND:$env:IMAGE_TAG `
            --set container.port=80 `
            --wait --timeout 300s
          kubectl -n mernapp rollout status deploy/frontend --timeout=300s
        '''
      }
    }

    stage('Deploy Ingress (Helm â†’ nginx-mern)'){
      steps {
        powershell '''
          $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
          
          Set-Location "$env:WORKSPACE\\K8s-helm\\ingress"

          helm upgrade --install ingress . -n mernapp --wait --timeout 300s
          kubectl -n mernapp get ing
        '''
      }
    }

    stage('Cluster Check'){
      steps {
        powershell '''
          $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
          kubectl -n mernapp get pods,svc,ing -o wide
        '''
      }
    }
  }

  post { 
    always { 
      powershell 'docker image prune -f' 
      
      // Clean up the kubeconfig file from the workspace
      powershell 'Remove-Item -Path "$env:WORKSPACE\\kubeconfig" -ErrorAction SilentlyContinue' 
    } 
  }
}