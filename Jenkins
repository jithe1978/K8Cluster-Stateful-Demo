pipeline {
  agent any

  environment {
    AWS_REGION      = 'us-east-2'
    AWS_ACCOUNT_ID  = '577999460012'
    ECR_BACKEND     = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/mern-backend"
    ECR_FRONTEND    = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/mern-frontend"
    IMAGE_TAG       = "${env.GIT_COMMIT.take(7)}"
    WORKDIR         = 'K8Networking'
  }

  options { disableConcurrentBuilds(); timestamps() }

  stages {
    stage('Checkout'){ steps { checkout scm } }

    stage('Init Tooling'){
      steps {
        withCredentials([
          usernamePassword(credentialsId: 'aws-creds', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY'),
          string(credentialsId: 'kubeconfig-content', variable: 'KUBECONFIG_CONTENT')
        ]) {
          powershell '''
            Set-Content -Path "$env:WORKSPACE\\kubeconfig" -Value $env:KUBECONFIG_CONTENT -Encoding Ascii
            $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
            aws --version; kubectl version --client=true; helm version
          '''
        }
      }
    }

    stage('ECR Login & Repos'){
      steps {
        powershell '''
          aws ecr get-login-password --region $env:AWS_REGION |
            docker login --username AWS --password-stdin $env:AWS_ACCOUNT_ID.dkr.ecr.$env:AWS_REGION.amazonaws.com

          aws ecr describe-repositories --repository-names mern-backend  --region $env:AWS_REGION 2>$null
          aws ecr describe-repositories --repository-names mern-frontend --region $env:AWS_REGION 2>$null
          '''
      }
    }

    stage('Build & Push Images'){
      steps {
        powershell '''
          Write-Host "Building backend in $env:WORKSPACE\\API-jokes"
          Set-Location "$env:WORKSPACE\\API-jokes"
          docker build -t $env:ECR_BACKEND:$env:IMAGE_TAG -t $env:ECR_BACKEND:latest -f Dockerfile.prod .\\API-jokes
          docker push  $env:ECR_BACKEND:$env:IMAGE_TAG
          docker push  $env:ECR_BACKEND:latest
          # 3. Change to the frontend directory
          Write-Host "Building frontend in $env:WORKSPACE\\react-client"
          Set-Location "$env:WORKSPACE\\react-client"
          docker build -t $env:ECR_FRONTEND:$env:IMAGE_TAG -t $env:ECR_FRONTEND:latest -f Dockerfile.prod .\\react-client
          docker push  $env:ECR_FRONTEND:$env:IMAGE_TAG
          docker push  $env:ECR_FRONTEND:latest
        '''
      }
    }

    stage('Namespace & Secret check (mernapp)'){
      steps {
        powershell '''
          $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
          kubectl get ns mernapp 2>$null; if ($LASTEXITCODE -ne 0) { kubectl create ns mernapp }
          kubectl -n mernapp get secret mongodb-cred
        '''
      }
    }

    stage('Deploy Backend (Helm)'){
      steps {
        powershell '''
          $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
          cd $env:WORKDIR
          helm upgrade --install backend K8s-helm\\backend -n mernapp `
            --set container.image=$env:ECR_BACKEND:$env:IMAGE_TAG `
            --set container.port=5000 `
            --wait --timeout 300s
          kubectl -n mernapp rollout status deploy/backend --timeout=300s
        '''
      }
    }

    stage('Deploy Frontend (Helm)'){
      steps {
        powershell '''
          $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
          cd $env:WORKDIR
          helm upgrade --install frontend K8s-helm\\frontend -n mernapp `
            --set container.image=$env:ECR_FRONTEND:$env:IMAGE_TAG `
            --set container.port=80 `
            --wait --timeout 300s
          kubectl -n mernapp rollout status deploy/frontend --timeout=300s
        '''
      }
    }

    stage('Deploy Ingress (Helm â†’ nginx-mern)'){
      steps {
        powershell '''
          $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
          cd $env:WORKDIR
          helm upgrade --install ingress K8s-helm\\ingress -n mernapp --wait --timeout 300s
          kubectl -n mernapp get ing
        '''
      }
    }

    stage('Cluster Check'){
      steps {
        powershell '''
          $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
          kubectl -n mernapp get pods,svc,ing -o wide
        '''
      }
    }
  }

  post { always { powershell 'docker image prune -f' } }
}