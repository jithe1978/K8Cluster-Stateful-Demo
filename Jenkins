pipeline {
    agent any

    environment {
        AWS_REGION     = 'us-east-2'
        AWS_ACCOUNT_ID = '577999460012'
        // This will be set by the 'Init Tooling' stage
        KUBECONFIG = '' 
    }

    options { disableConcurrentBuilds(); timestamps() }

    stages {
        stage('Checkout'){ 
            steps { 
                checkout scm 
                script {
                    env.IMAGE_TAG = env.GIT_COMMIT.take(7)
                    echo "IMAGE_TAG=${env.IMAGE_TAG}"
                }
            } 
        }

        // --- UPDATED STAGE ---
stage('Init Tooling'){
            steps {
                withCredentials([
                    file(credentialsId: 'kubeconfig-content-1', variable: 'KUBECONFIG_FILE_PATH')
                ]) {
                    // --- CHANGE: Use triple-single-quotes ''' ---
                    powershell '''
                        # These are now treated as pure PowerShell variables
                        $env:KUBECONFIG = $env:KUBECONFIG_FILE_PATH
                        Write-Host "Kubeconfig set up from secret file: $env:KUBECONFIG"
                        
                        "KUBECONFIG=$env:KUBECONFIG_FILE_PATH" | Out-File -FilePath env.properties -Encoding ascii -Append

                        aws --version
                        kubectl version --client=true
                        helm version

                        Write-Host "--- Available Kubeconfig Contexts ---"
                        kubectl config get-contexts
                        Write-Host "---------------------------------------"
                    '''
                    // --- END CHANGE ---

                    // This part is unchanged
                    load 'env.properties'
                    script {
                        echo "Pipeline KUBECONFIG variable set to: ${env.KUBECONFIG}"
                    }
                }
            }
        }

        // --- UPDATED STAGE ---
        stage('ECR Login & Repos'){
            steps {
                withCredentials([
                    usernamePassword(credentialsId: 'aws-creds', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')
                ]) {
                    // Use """ (triple-double quotes) to allow ${env.AWS_REGION} etc.
                    powershell """
                        $ErrorActionPreference = "Stop"
                        $ECR_REGISTRY = "${env.AWS_ACCOUNT_ID}.dkr.ecr.${env.AWS_REGION}.amazonaws.com"
                        Write-Host "Verifying AWS identity..."
                        aws sts get-caller-identity
                        
                        # This line is now fixed
                        Write-Host "Attempting to get ECR login password for region ${env.AWS_REGION}..."
                        $ecrPassword = aws ecr get-login-password --region ${env.AWS_REGION}
                        
                        if (-not \$ecrPassword) { 
                            Write-Error "aws ecr get-login-password returned an empty token."
                            exit 1 
                        }
                        Write-Host "Password token received, attempting Docker login to \$ECR_REGISTRY..."
                        try {
                            docker login --username AWS --password \$ecrPassword \$ECR_REGISTRY
                            Write-Host "Docker login successful."
                        } catch {
                            Write-Error "Docker login FAILED. See error details above."
                            exit 1 
                        }
                        Write-Host "ECR repos mern-backend and mern-frontend are assumed to exist."
                    """
                }
            }
        }
        
        // --- UPDATED STAGE ---
        stage('Build & Push Backend') {
            steps {
                dir('API-jokes') {
                    // Use """ (triple-double quotes)
                    powershell """
                        $ErrorActionPreference = "Stop"
                        $ECR_BACKEND = "${env.AWS_ACCOUNT_ID}.dkr.ecr.${env.AWS_REGION}.amazonaws.com/mern-backend"
                        Write-Host "Building backend image: ${ECR_BACKEND}:${env.IMAGE_TAG}"
                        docker build -t "${ECR_BACKEND}:${env.IMAGE_TAG}" -t "${ECR_BACKEND}:latest" -f Dockerfile.prod .
                        Write-Host "Pushing backend images..."
                        docker push "${ECR_BACKEND}:${env.IMAGE_TAG}"
                        docker push "${ECR_BACKEND}:latest"
                    """
                }
            }
        }
        
        // --- UPDATED STAGE ---
        stage('Build & Push Frontend') {
            steps {
                dir('react-client') {
                    // Use """ (triple-double quotes)
                    powershell """
                        $ErrorActionPreference = "Stop"
                        $ECR_FRONTEND = "${env.AWS_ACCOUNT_ID}.dkr.ecr.${env.AWS_REGION}.amazonaws.com/mern-frontend"
                        Write-Host "Building frontend image: ${ECR_FRONTEND}:${env.IMAGE_TAG}"
                        docker build -t "${ECR_FRONTEND}:${env.IMAGE_TAG}" -t "${ECR_FRONTEND}:latest" -f Dockerfile.prod .
                        Write-Host "Pushing frontend images..."
                        docker push "${ECR_FRONTEND}:${env.IMAGE_TAG}"
                        docker push "${ECR_FRONTEND}:latest"
                    """
                }
            }
        }

        // --- UPDATED STAGE ---
        stage('Namespace & Secret check (mernapp)'){
            steps {
                // Use """ (triple-double quotes)
                powershell """
                    $ErrorActionPreference = "Stop"
                    $CACHE_PATH = "${env.WORKSPACE}\\.kube-cache"
                    Write-Host "Checking for namespace 'mernapp' using default context..."
                    
                    $ns = kubectl get ns mernapp -o name --cache-dir=\$CACHE_PATH 2>\$null
                    if (-not \$ns) {
                        Write-Host "Namespace mernapp not found, creating..."
                        kubectl create ns mernapp --cache-dir=\$CACHE_PATH
                    } else {
                        Write-Host "Namespace mernapp already exists."
                    }
                    
                    Write-Host "Checking for secret 'mongodb-cred' using default context..."
                    kubectl -n mernapp get secret mongodb-cred --cache-dir=\$CACHE_PATH
                    Write-Host "Secret mongodb-cred found."
                """
            }
        }

        // --- UPDATED STAGE ---
        stage('Deploy Backend (Helm)'){
            steps {
                // Use """ (triple-double quotes)
                powershell """
                    $ErrorActionPreference = "Stop"
                    $CACHE_PATH = "${env.WORKSPACE}\\.kube-cache"
                    $ECR_BACKEND = "${env.AWS_ACCOUNT_ID}.dkr.ecr.${env.AWS_REGION}.amazonaws.com/mern-backend"
                    Write-Host "Deploying backend helm chart using default context..."
                    $chartPath = "\$env:WORKSPACE\\K8s-helm\\backend"
                    
                    helm upgrade --install backend \$chartPath -n mernapp `
                        --set container.image="${ECR_BACKEND}:${env.IMAGE_TAG}" `
                        --set container.port=5000 `
                        --wait --timeout 300s
                        
                    Write-Host "Waiting for backend rollout..."
                    kubectl -n mernapp rollout status deploy/mern-backend --timeout=300s --cache-dir=\$CACHE_PATH
                """
            }
        }

        // --- UPDATED STAGE ---
        stage('Deploy Frontend (Helm)'){
            steps {
                // Use """ (triple-double quotes)
                powershell """
                    $ErrorActionPreference = "Stop"
                    $CACHE_PATH = "${env.WORKSPACE}\\.kube-cache"
                    $ECR_FRONTEND = "${env.AWS_ACCOUNT_ID}.dkr.ecr.${env.AWS_REGION}.amazonaws.com/mern-frontend"
                    Write-Host "Deploying frontend helm chart using default context..."
                    $chartPath = "\$env:WORKSPACE\\K8s-helm\\frontend"
                    
                    helm upgrade --install frontend \$chartPath -n mernapp `
                        --set container.image="${ECR_FRONTEND}:${env.IMAGE_TAG}" `
                        --set container.port=80 `
                        --wait --timeout 300s
                        
                    Write-Host "Waiting for frontend rollout..."
                    kubectl -n mernapp rollout status deploy/frontend --timeout=300s --cache-dir=\$CACHE_PATH
                """
            }
        }

        // --- UPDATED STAGE ---
        stage('Deploy Ingress (Helm â†’ nginx-mern)'){
            steps {
                // Use """ (triple-double quotes)
                powershell """
                    $ErrorActionPreference = "Stop"
                    $CACHE_PATH = "${env.WORKSPACE}\\.kube-cache"
                    Write-Host "Deploying ingress helm chart using default context..."
                    $chartPath = "\$env:WORKSPACE\\K8s-helm\\ingress"

                    helm upgrade --install ingress \$chartPath -n mernapp --wait --timeout 300s
                    kubectl -n mernapp get ing --cache-dir=\$CACHE_PATH
                """
            }
        }

        // --- UPDATED STAGE ---
        stage('Cluster Check'){
            steps {
                // Use """ (triple-double quotes)
                powershell """
                    $ErrorActionPreference = "Stop"
                    $CACHE_PATH = "${env.WORKSPACE}\\.kube-cache"
                    Write-Host "Final cluster check (default context):"
                    
                    kubectl -n mernapp get pods,svc,ing -o wide --cache-dir=\$CACHE_PATH
                """
            }
        }
    }

    post { 
        always { 
            // Simple commands can use single-quotes
            powershell 'docker image prune -f'
            
            // This will now work because env.KUBECONFIG is set correctly
            powershell 'Remove-Item -Path $env:KUBECONFIG -ErrorAction SilentlyContinue' 
            
            // Use """ to interpolate ${env.WORKSPACE}
            powershell """
                Remove-Item -Path "${env.WORKSPACE}\\.kube-cache" -Recurse -Force -ErrorAction SilentlyContinue
                Remove-Item -Path "${env.WORKSPACE}\\env.properties" -ErrorAction SilentlyContinue
            """
        } 
    }
}