pipeline {
    agent any

    environment {
        AWS_REGION     = 'us-east-2'
        AWS_ACCOUNT_ID = '577999460012'
        KUBECONFIG = ''
    }

    options { disableConcurrentBuilds(); timestamps() }

    stages {
        stage('Checkout'){ 
            steps { 
                checkout scm 
                script {
                    env.IMAGE_TAG = env.GIT_COMMIT.take(7)
                    echo "IMAGE_TAG=${env.IMAGE_TAG}"
                }
            } 
        }

        // --- This stage is correct and needs no changes ---
        stage('Init Tooling'){
            steps {
                withCredentials([
                    file(credentialsId: 'kubeconfig-content-1', variable: 'KUBECONFIG_FILE_PATH')
                ]) {
                    powershell '''
                        $env:KUBECONFIG = $env:KUBECONFIG_FILE_PATH
                        Write-Host "Kubeconfig set up from secret file: $env:KUBECONFIG"
                        
                        aws --version
                        kubectl version --client=true
                        helm version

                        Write-Host "--- Available Kubeconfig Contexts ---"
                        kubectl config get-contexts
                        Write-Host "---------------------------------------"
                    '''
                    script {
                        env.KUBECONFIG = KUBECONFIG_FILE_PATH
                        echo "Pipeline KUBECONFIG variable set to: ${env.KUBECONFIG}"
                    }
                }
            }
        }

        stage('ECR Login & Repos'){
            // (No changes needed in this stage)
            steps {
                withCredentials([
                    usernamePassword(credentialsId: 'aws-creds', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')
                ]) {
                    powershell '''
                        $ErrorActionPreference = "Stop"
                        $ECR_REGISTRY = "${env:AWS_ACCOUNT_ID}.dkr.ecr.${env:AWS_REGION}.amazonaws.com"
                        Write-Host "Verifying AWS identity..."
                        aws sts get-caller-identity
                        Write-Host "Attempting to get ECR login password for region ${env:AWS_REGION}..."
                        $ecrPassword = aws ecr get-login-password --region ${env:AWS_REGION}
                        if (-not $ecrPassword) { 
                            Write-Error "aws ecr get-login-password returned an empty token."
                            exit 1 
                        }
                        Write-Host "Password token received, attempting Docker login to $ECR_REGISTRY..."
                        try {
                            docker login --username AWS --password $ecrPassword $ECR_REGISTRY
                            Write-Host "Docker login successful."
                        } catch {
                            Write-Error "Docker login FAILED. See error details above."
                            exit 1 
                        }
                        Write-Host "ECR repos mern-backend and mern-frontend are assumed to exist."
                    '''
                }
            }
        }
        
        stage('Build & Push Backend') {
            // (No changes needed in this stage)
            steps {
                dir('API-jokes') {
                    powershell '''
                        $ErrorActionPreference = "Stop"
                        $ECR_BACKEND = "${env:AWS_ACCOUNT_ID}.dkr.ecr.${env:AWS_REGION}.amazonaws.com/mern-backend"
                        Write-Host "Building backend image: ${ECR_BACKEND}:${env:IMAGE_TAG}"
                        docker build -t "${ECR_BACKEND}:${env:IMAGE_TAG}" -t "${ECR_BACKEND}:latest" -f Dockerfile.prod .
                        Write-Host "Pushing backend images..."
                        docker push "${ECR_BACKEND}:${env:IMAGE_TAG}"
                        docker push "${ECR_BACKEND}:latest"
                    '''
                }
            }
        }
        
        stage('Build & Push Frontend') {
            // (No changes needed in this stage)
            steps {
                dir('react-client') {
                    powershell '''
                        $ErrorActionPreference = "Stop"
                        $ECR_FRONTEND = "${env:AWS_ACCOUNT_ID}.dkr.ecr.${env:AWS_REGION}.amazonaws.com/mern-frontend"
                        Write-Host "Building frontend image: ${ECR_FRONTEND}:${env:IMAGE_TAG}"
                        docker build -t "${ECR_FRONTEND}:${env:IMAGE_TAG}" -t "${ECR_FRONTEND}:latest" -f Dockerfile.prod .
                        Write-Host "Pushing frontend images..."
                        docker push "${ECR_FRONTEND}:${env:IMAGE_TAG}"
                        docker push "${ECR_FRONTEND}:latest"
                    '''
                }
            }
        }

        // --- UPDATED STAGE ---
        // Added --cache-dir="NUL" to all kubectl commands
        stage('Namespace & Secret check (mernapp)'){
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"
                    Write-Host "Checking for namespace mernapp using default context..."
                    
                    $ns = kubectl get ns mernapp -o name --cache-dir="NUL" 2>$null
                    if (-not $ns) {
                        Write-Host "Namespace mernapp not found, creating..."
                        kubectl create ns mernapp --cache-dir="NUL"
                    } else {
                        Write-Host "Namespace mernapp already exists."
                    }
                    
                    Write-Host "Checking for secret mongodb-cred using default context..."
                    kubectl -n mernapp get secret mongodb-cred --cache-dir="NUL"
                    Write-Host "Secret mongodb-cred found."
                '''
            }
        }

        // --- UPDATED STAGE ---
        // Added --cache-dir="NUL" to the kubectl rollout command
        stage('Deploy Backend (Helm)'){
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"
                    $ECR_BACKEND = "${env:AWS_ACCOUNT_ID}.dkr.ecr.${env:AWS_REGION}.amazonaws.com/mern-backend"
                    Write-Host "Deploying backend helm chart using default context..."
                    $chartPath = "$env:WORKSPACE\\K8s-helm\\backend"
                    
                    helm upgrade --install backend $chartPath -n mernapp `
                        --set container.image="${ECR_BACKEND}:${env:IMAGE_TAG}" `
                        --set container.port=5000 `
                        --wait --timeout 300s
                        
                    Write-Host "Waiting for backend rollout..."
                    kubectl -n mernapp rollout status deploy/mern-backend --timeout=300s --cache-dir="NUL"
                '''
            }
        }

        // --- UPDATED STAGE ---
        // Added --cache-dir="NUL" to the kubectl rollout command
        stage('Deploy Frontend (Helm)'){
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"
                    $ECR_FRONTEND = "${env:AWS_ACCOUNT_ID}.dkr.ecr.${env:AWS_REGION}.amazonaws.com/mern-frontend"
                    Write-Host "Deploying frontend helm chart using default context..."
                    $chartPath = "$env:WORKSPACE\\K8s-helm\\frontend"
                    
                    helm upgrade --install frontend $chartPath -n mernapp `
                        --set container.image="${ECR_FRONTEND}:${env:IMAGE_TAG}" `
                        --set container.port=80 `
                        --wait --timeout 300s
                        
                    Write-Host "Waiting for frontend rollout..."
                    kubectl -n mernapp rollout status deploy/frontend --timeout=300s --cache-dir="NUL"
                '''
            }
        }

        // --- UPDATED STAGE ---
        // Added --cache-dir="NUL" to the kubectl get ing command
        stage('Deploy Ingress (Helm â†’ nginx-mern)'){
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"
                    Write-Host "Deploying ingress helm chart using default context..."
                    $chartPath = "$env:WORKSPACE\\K8s-helm\\ingress"

                    helm upgrade --install ingress $chartPath -n mernapp --wait --timeout 300s
                    kubectl -n mernapp get ing --cache-dir="NUL"
                '''
            }
        }

        // --- UPDATED STAGE ---
        // Added --cache-dir="NUL" to the kubectl get command
        stage('Cluster Check'){
            steps {
                powershell '''
                    $ErrorActionPreference = "Stop"
                    Write-Host "Final cluster check (default context):"
                    
                    kubectl -n mernapp get pods,svc,ing -o wide --cache-dir="NUL"
                '''
            }
        }
    }

    post { 
        always { 
            powershell 'docker image prune -f' 
            powershell 'Remove-Item -Path $env:KUBECONFIG -ErrorAction SilentlyContinue' 
        } 
    }
}