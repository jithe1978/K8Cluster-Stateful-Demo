pipeline {
  agent any

  environment {
    AWS_REGION     = 'us-east-2'
    AWS_ACCOUNT_ID = '577999460012'
    # These are static strings, so defining them here is fine.
    ECR_REGISTRY   = "577999460012.dkr.ecr.us-east-2.amazonaws.com"
    ECR_BACKEND    = "577999460012.dkr.ecr.us-east-2.amazonaws.com/mern-backend"
    ECR_FRONTEND   = "577999460012.dkr.ecr.us-east-2.amazonaws.com/mern-frontend"
  }

  options { disableConcurrentBuilds(); timestamps() }

  stages {
    stage('Checkout'){ 
      steps { 
        checkout scm 
        script {
          // .take(7) is Groovy, this is correct.
          env.IMAGE_TAG = env.GIT_COMMIT.take(7)
          echo "IMAGE_TAG=${env.IMAGE_TAG}"
        }
      } 
    }

    stage('Init Tooling'){
      steps {
        withCredentials([
          string(credentialsId: 'kubeconfig-content', variable: 'KUBECONFIG_CONTENT')
        ]) {
          # --- Switched to 'sh' ---
          sh '''
            # Create the kubeconfig file
            echo "$KUBECONFIG_CONTENT" > kubeconfig
            
            # Set KUBECONFIG for all subsequent stages
            # We must export it so other 'sh' steps can see it
            export KUBECONFIG="$WORKSPACE/kubeconfig"
            
            echo "Kubeconfig set up."
            aws --version
            kubectl version --client=true
            helm version
          '''
        }
      }
    }

    stage('ECR Login & Repos'){
      steps {
        withCredentials([
          usernamePassword(credentialsId: 'aws-creds', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          # --- Switched to 'sh' ---
          sh '''
            set -e # Exit immediately if a command fails
            
            echo "Verifying AWS identity..."
            aws sts get-caller-identity

            echo "Attempting to get ECR login password for region ${AWS_REGION}..."
            aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}
            
            echo "Docker login successful."
            echo "ECR repos mern-backend and mern-frontend are assumed to exist."
          '''
        }
      }
    }

    # --- SIMPLIFIED BUILD & PUSH STAGES (using 'sh') ---
    
    stage('Build & Push Backend') {
      steps {
        # 1. Change to the correct directory
        dir('API-jokes') {
          # 2. Use 'sh'
          sh '''
            set -e 
            echo "Building backend image: ${ECR_BACKEND}:${IMAGE_TAG}"
            docker build -t "${ECR_BACKEND}:${IMAGE_TAG}" -t "${ECR_BACKEND}:latest" -f Dockerfile.prod .
            
            echo "Pushing backend images..."
            docker push "${ECR_BACKEND}:${IMAGE_TAG}"
            docker push "${ECR_BACKEND}:latest"
          '''
        }
      }
    }
    
    stage('Build & Push Frontend') {
      steps {
        # 1. Change to the correct directory
        dir('react-client') {
          # 2. Use 'sh'
          sh '''
            set -e
            echo "Building frontend image: ${ECR_FRONTEND}:${IMAGE_TAG}"
            docker build -t "${ECR_FRONTEND}:${IMAGE_TAG}" -t "${ECR_FRONTEND}:latest" -f Dockerfile.prod .
            
            echo "Pushing frontend images..."
            docker push "${ECR_FRONTEND}:${IMAGE_TAG}"
            docker push "${ECR_FRONTEND}:latest"
          '''
        }
      }
    }

    stage('Namespace & Secret check (mernapp)'){
      steps {
        sh '''
          set -e
          export KUBECONFIG="$WORKSPACE/kubeconfig"
          
          echo "Checking for namespace 'mernapp'..."
          # The '||' operator works perfectly in 'sh'
          kubectl get ns mernapp -o name || kubectl create ns mernapp
          
          echo "Checking for secret 'mongodb-cred'..."
          kubectl -n mernapp get secret mongodb-cred
          echo "Secret 'mongodb-cred' found."
        '''
      }
    }

    stage('Deploy Backend (Helm)'){
      steps {
        sh '''
          set -e
          export KUBECONFIG="$WORKSPACE/kubeconfig"
          
          echo "Deploying backend helm chart..."
          CHART_PATH="$WORKSPACE/K8s-helm/backend"
          
          helm upgrade --install backend $CHART_PATH -n mernapp \
            --set container.image="${ECR_BACKEND}:${IMAGE_TAG}" \
            --set container.port=5000 \
            --wait --timeout 300s
            
          echo "Waiting for backend rollout..."
          kubectl -n mernapp rollout status deploy/mern-backend --timeout=300s
        '''
      }
    }

    stage('Deploy Frontend (Helm)'){
      steps {
        sh '''
          set -e
          export KUBECONFIG="$WORKSPACE/kubeconfig"
          
          echo "Deploying frontend helm chart..."
          CHART_PATH="$WORKSPACE/K8s-helm/frontend"
          
          helm upgrade --install frontend $CHART_PATH -n mernapp \
            --set container.image="${ECR_FRONTEND}:${IMAGE_TAG}" \
            --set container.port=80 \
            --wait --timeout 300s
            
          echo "Waiting for frontend rollout..."
          kubectl -n mernapp rollout status deploy/frontend --timeout=300s
        '''
      }
    }

    stage('Deploy Ingress (Helm â†’ nginx-mern)'){
      steps {
        sh '''
          set -e
          export KUBECONFIG="$WORKSPACE/kubeconfig"
          
          echo "Deploying ingress helm chart..."
          CHART_PATH="$WORKSPACE/K8s-helm/ingress"

          helm upgrade --install ingress $CHART_PATH -n mernapp --wait --timeout 300s
          kubectl -n mernapp get ing
        '''
      }
    }

    stage('Cluster Check'){
      steps {
        sh '''
          set -e
          export KUBECONFIG="$WORKSPACE/kubeconfig"
          
          echo "Final cluster check:"
          kubectl -n mernapp get pods,svc,ing -o wide
        '''
      }
    }
  }

  post { 
    always { 
      sh 'docker image prune -f' 
      sh 'rm -f "$WORKSPACE/kubeconfig"' 
    } 
  }
}