pipeline {
  agent any

  environment {
    AWS_REGION     = 'us-east-2'
    AWS_ACCOUNT_ID = '577999460012'
    ECR_REGISTRY   = "577999460012.dkr.ecr.us-east-2.amazonaws.com"
    ECR_BACKEND    = "577999460012.dkr.ecr.us-east-2.amazonaws.com/mern-backend"
    ECR_FRONTEND   = "577999460012.dkr.ecr.us-east-2.amazonaws.com/mern-frontend"
  }

  options { disableConcurrentBuilds(); timestamps() }

stages {
    stage('Checkout'){ 
      steps { 
        checkout scm 
        script {
          env.IMAGE_TAG = env.GIT_COMMIT.take(7)
          echo "IMAGE_TAG=${env.IMAGE_TAG}"
        }
      } 
    }

    stage('Init Tooling'){
      steps {
        withCredentials([
          string(credentialsId: 'kubeconfig-content', variable: 'KUBECONFIG_CONTENT')
        ]) {
          powershell '''
            Set-Content -Path "$env:WORKSPACE\\kubeconfig" -Value $env:KUBECONFIG_CONTENT -Encoding Ascii
            $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
            Write-Host "Kubeconfig set up."
            aws --version
            kubectl version --client=true
            helm version
          '''
        }
      }
    }

    stage('ECR Login & Repos'){
      steps {
        withCredentials([
          usernamePassword(credentialsId: 'aws-creds', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          powershell '''
            $ErrorActionPreference = "Stop"

            # --- FIX ---
            # Define ECR_REGISTRY *inside* the script
            $ECR_REGISTRY = "${env:AWS_ACCOUNT_ID}.dkr.ecr.${env:AWS_REGION}.amazonaws.com"

            Write-Host "Verifying AWS identity..."
            aws sts get-caller-identity

            Write-Host "Attempting to get ECR login password for region $env:AWS_REGION..."
            $ecrPassword = aws ecr get-login-password --region $env:AWS_REGION
            
            if (-not $ecrPassword) {
              Write-Error "aws ecr get-login-password returned an empty token."
              exit 1 # Fail the build
            }

            Write-Host "Password token received, attempting Docker login to $ECR_REGISTRY..."
            
            try {
              # Use --password $ecrPassword, which is more reliable than piping
              docker login --username AWS --password $ecrPassword $ECR_REGISTRY
              Write-Host "Docker login successful."
            } catch {
              Write-Error "Docker login FAILED. See error details above."
              exit 1 # Exit with a non-zero code to fail the build
            }
            
            Write-Host "ECR repos mern-backend and mern-frontend are assumed to exist."
          '''
        }
      }
    }

    stage('Build & Push Images'){
      steps {
        withCredentials([
          usernamePassword(credentialsId: 'aws-creds', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          powershell '''
            $ErrorActionPreference = "Stop"
            
            # --- FIX ---
            # Define ECR_BACKEND and ECR_FRONTEND *inside* the script
            $ECR_BACKEND  = "${env:AWS_ACCOUNT_ID}.dkr.ecr.${env:AWS_REGION}.amazonaws.com/mern-backend"
            $ECR_FRONTEND = "${env:AWS_ACCOUNT_ID}.dkr.ecr.${env:AWS_REGION}.amazonaws.com/mern-frontend"

            # We are now passing the *full explicit path* to the Dockerfile
            # and the *full explicit path* for the build context.
            
            Write-Host "Building backend in $env:WORKSPACE\\API-jokes"
            docker build -t "$ECR_BACKEND:${env:IMAGE_TAG}" -t "$ECR_BACKEND:latest" -f "$env:WORKSPACE\\API-jokes\\Dockerfile.prod" "$env:WORKSPACE\\API-jokes"
            
            Write-Host "Pushing backend to ECR..."
            docker push "$ECR_BACKEND:${env:IMAGE_TAG}"
            docker push "$ECR_BACKEND:latest"

            Write-Host "Building frontend in $env:WORKSPACE\\react-client"
            docker build -t "$ECR_FRONTEND:${env:IMAGE_TAG}" -t "$ECR_FRONTEND:latest" -f "$env:WORKSPACE\\react-client\\Dockerfile.prod" "$env:WORKSPACE\\react-client"
            
            Write-Host "Pushing frontend to ECR..."
            docker push "$ECR_FRONTEND:${env:IMAGE_TAG}"
            docker push "$ECR_FRONTEND:latest"
            
            Write-Host "Build & Push complete."
          '''
        }
      }
    }

    stage('Namespace & Secret check (mernapp)'){
      steps {
        powershell '''
          $ErrorActionPreference = "Stop"
          $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
          
          Write-Host "Checking for namespace mernapp..."
          # Use -ErrorAction SilentlyContinue to suppress "Not Found" error
          $ns = kubectl get ns mernapp -o name 2>$null
          if (-not $ns) {
            Write-Host "Namespace mernapp not found, creating..."
            kubectl create ns mernapp 
          } else {
            Write-Host "Namespace mernapp already exists."
          }
          
          Write-Host "Checking for secret mongodb-cred..."
          # This command will fail if the secret doesn't exist. 
          # You must create it manually or add it to your Helm chart.
          kubectl -n mernapp get secret mongodb-cred
          Write-Host "Secret 'mongodb-cred' found."
        '''
      }
    }

    stage('Deploy Backend (Helm)'){
      steps {
        powershell '''
          $ErrorActionPreference = "Stop"
          $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
          
          # --- FIX ---
          # Define ECR_BACKEND *inside* the script
          $ECR_BACKEND = "${env:AWS_ACCOUNT_ID}.dkr.ecr.${env:AWS_REGION}.amazonaws.com/mern-backend"

          Write-Host "Deploying backend helm chart..."
          # Pass the full chart path to helm, which is more reliable
          $chartPath = "$env:WORKSPACE\\K8s-helm\\backend"
          
          helm upgrade --install backend $chartPath -n mernapp `
            --set container.image="$ECR_BACKEND:${env:IMAGE_TAG}" `
            --set container.port=5000 `
            --wait --timeout 300s
            
          Write-Host "Waiting for backend rollout..."
          kubectl -n mernapp rollout status deploy/mern-backend --timeout=300s
        '''
      }
    }

    stage('Deploy Frontend (Helm)'){
      steps {
        powershell '''
          $ErrorActionPreference = "Stop"
          $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
          
          # --- FIX ---
          # Define ECR_FRONTEND *inside* the script
          $ECR_FRONTEND = "${env:AWS_ACCOUNT_ID}.dkr.ecr.${env:AWS_REGION}.amazonaws.com/mern-frontend"
          
          Write-Host "Deploying frontend helm chart..."
          $chartPath = "$env:WORKSPACE\\K8s-helm\\frontend"
          
          helm upgrade --install frontend $chartPath -n mernapp `
            --set container.image="$ECR_FRONTEND:${env:IMAGE_TAG}" `
            --set container.port=80 `
            --wait --timeout 300s
            
          Write-Host "Waiting for frontend rollout..."
          kubectl -n mernapp rollout status deploy/frontend --timeout=300s
        '''
      }
    }

    stage('Deploy Ingress (Helm â†’ nginx-mern)'){
      steps {
        powershell '''
          $ErrorActionPreference = "Stop"
          $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
          
          Write-Host "Deploying ingress helm chart..."
          $chartPath = "$env:WORKSPACE\\K8s-helm\\ingress"

          helm upgrade --install ingress $chartPath -n mernapp --wait --timeout 300s
          kubectl -n mernapp get ing
        '''
      }
    }

    stage('Cluster Check'){
      steps {
        powershell '''
          $ErrorActionPreference = "Stop"
          $env:KUBECONFIG = "$env:WORKSPACE\\kubeconfig"
          
          Write-Host "Final cluster check:"
          kubectl -n mernapp get pods,svc,ing -o wide
        '''
      }
    }
  }

  post { 
    always { 
      powershell 'docker image prune -f' 
      powershell 'Remove-Item -Path "$env:WORKSPACE\\kubeconfig" -ErrorAction SilentlyContinue' 
    } 
  }
}